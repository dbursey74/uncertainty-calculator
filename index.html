<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Measurement Uncertainty Calculator</title>

<style>
  body {
    font-family: Arial, sans-serif;
    margin: 40px;
  }

  .card {
    max-width: 560px;
    margin: 24px auto;
    padding: 20px;
    border: 1px solid #ddd;
    border-radius: 12px;
  }

  label {
    display: block;
    margin: 14px 0 6px;
    font-weight: 600;
  }

  input {
    width: 100%;
    padding: 10px;
    border: 1px solid #ccc;
    border-radius: 8px;
    box-sizing: border-box;
  }

  button {
    margin-top: 16px;
    padding: 10px 14px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
  }

  pre#result {
    margin-top: 16px;
    padding: 12px;
    border: 1px solid #eee;
    border-radius: 8px;
    white-space: pre-wrap;
  }
</style>

</head>
<body>

<h2>Measurement Uncertainty Calculator</h2>
<p>Quickly compute combined and expanded uncertainty (k-factor) for documentation and engineering use.</p>

<div class="card">

<label>Access Code</label>
<input id="code" placeholder="Enter your access code" />

<label>Accuracy (±)</label>
<input id="accuracy" type="number" step="any" placeholder="e.g., 0.06" />

<label>Resolution</label>
<input id="resolution" type="number" step="any" placeholder="e.g., 0.01" />

<label>Repeatability (optional)</label>
<input id="repeatability" type="number" step="any" placeholder="e.g., 0.02 (leave blank if none)" />

<label>Coverage factor (k)</label>
<input id="kfactor" type="number" step="any" value="2" />

<label>Units (optional)</label>
<input id="units" placeholder="e.g., °C, mm, psi" />

<button onclick="onCheckClick()">Calculate &amp; Consume Credit</button>

<pre id="result"></pre>

</div>
  
<script>
const API_URL = "https://script.google.com/macros/s/AKfycbwytGF5f0t0b5caus6XdsGfqgakaILZBTSUeIQfiwALTrt25iKmX6rVnwrzHvUJywnw/exec";   // must end in /exec
const API_KEY = "r9K3ZP2A8fLQXwM7D1k2Vn8Pp4sT6yZ";

const round = (x) => Math.round(x * 1000000) / 1000000;

async function consumeCredit(code) {
  const res = await fetch(API_URL, {
    method: "POST",
    headers: { "Content-Type": "text/plain;charset=UTF-8" }, // avoids preflight
    body: JSON.stringify({
      action: "consume",
      code: code,
      apiKey: API_KEY
    })
  });
  return await res.json();
}

function validateInputs(acc, res, rep, k) {
  if (!Number.isFinite(acc) || acc <= 0) return "Accuracy must be > 0";
  if (!Number.isFinite(res) || res <= 0) return "Resolution must be > 0";
  if (rep !== null && (!Number.isFinite(rep) || rep < 0)) return "Repeatability must be >= 0 (or blank)";
  if (!Number.isFinite(k) || k <= 0) return "Coverage factor k must be > 0";
  return null;
}

// Practical, defensible approach:
// accuracy and resolution treated as rectangular distributions
function calcUncertainty(acc, res, rep, k) {
  const uAcc = acc / Math.sqrt(3);
  const uRes = res / Math.sqrt(12);
  const uRep = rep ?? 0;

  const uc = Math.sqrt(uAcc*uAcc + uRes*uRes + uRep*uRep);
  const U = k * uc;

  return { uAcc, uRes, uRep, uc, U };
}

async function onCheckClick() {
  const resultEl = document.getElementById("result");
  if (!resultEl) { alert("Missing result element"); return; }

  const code = document.getElementById("code")?.value.trim() || "";

  const acc = Number(document.getElementById("accuracy")?.value);
  const res = Number(document.getElementById("resolution")?.value);

  const repRaw = document.getElementById("repeatability")?.value ?? "";
  const rep = repRaw === "" ? null : Number(repRaw);

  const k = Number(document.getElementById("kfactor")?.value || 2);
  const units = (document.getElementById("units")?.value || "").trim();
  const unitTxt = units ? ` ${units}` : "";

  const err = validateInputs(acc, res, rep, k);
  if (err) { alert(err); return; }

  resultEl.innerText = "Calculating…";

  let credit;
  try {
    credit = await consumeCredit(code);
  } catch (e) {
    resultEl.innerText = "";
    alert("Request failed. Open Console for details.");
    return;
  }

  if (!credit.ok) {
    resultEl.innerText = "";
    alert(credit.error || "No credits remaining");
    return;
  }

  const out = calcUncertainty(acc, res, rep, k);

  const uc = round(out.uc);
  const U  = round(out.U);

  resultEl.innerText =
    `Combined standard uncertainty (u_c): ${uc}${unitTxt}\n` +
    `Expanded uncertainty (k=${k}): ±${U}${unitTxt}\n\n` +
    `Details:\n` +
    `u_accuracy = ${round(out.uAcc)}${unitTxt} (accuracy/√3)\n` +
    `u_resolution = ${round(out.uRes)}${unitTxt} (resolution/√12)\n` +
    `u_repeatability = ${rep === null ? "N/A" : round(out.uRep)}${unitTxt}\n\n` +
    `Credits left: ${credit.credits_remaining}\n` +
    `Report statement: Expanded uncertainty (k=${k}): ±${U}${unitTxt}`;
}
</script>

</body>
</html>
<hr>
<h3>Need More Checks?</h3>
<p>50 additional tolerance checks — $10</p>
<p>After payment, your access code will be emailed within 24 hours.</p>

<a href="https://buy.stripe.com/00wcN41LwaywcV8gkX9MY00" target="_blank">
  Buy 50 Checks
</a>
